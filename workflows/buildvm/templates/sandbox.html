{% extends "layout.html" %}
{% block head -%}
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/vendor/bootstrap-select.min.css') }}?version={{ config.VERSION }}">
	<script type="text/javascript" src="{{ url_for('static', filename='js/vendor/bootstrap-select.min.js') }}?version={{ config.VERSION }}"></script>

	<link rel="stylesheet" href="{{ url_for('static', filename='css/vendor/tempusdominus-bootstrap-4.min.css') }}?version={{ config.VERSION }}">
	<script src="{{ url_for('static', filename='js/vendor/moment.min.js') }}?version={{ config.VERSION }}"></script>
	<script src="{{ url_for('static', filename='js/vendor/tether.min.js') }}?version={{ config.VERSION }}"></script>
	<script src="{{ url_for('static', filename='js/vendor/en-gb.js') }}?version={{ config.VERSION }}"></script>
	<script src="{{ url_for('static', filename='js/vendor/tempusdominus-bootstrap-4.min.js') }}?version={{ config.VERSION }}"></script>
{% endblock %}
{% block body %}

<div class="page-header">
<h4><i class="fa fa-plus-circle fa-fw"></i> Create Sandbox Virtual Machine</h4>
<div class="text-muted">This workflow will create a VM on the sandbox environment. A hostname will be automatically allocated from the 'play' group, and the VM will be configured to use DHCP. A ServiceNow CI will also be created automatically.</div>
</div>

<style type="text/css">
.blocks .btn
{
	width: 2.5em;
}
.btn-group .btn-primary, .btn-group .btn-warning, .btn-group .btn-success
{
	opacity: 0.7;
	font-size: 14px;
}
.active
{
	opacity: 1 !important;
}
.submit
{
	padding-bottom: 2em;
	margin-left: 1em;
}
.btn-submit
{
	font-size: 2em;
}
div.specname
{
	font-size: 200%; /* Relative to btn-primary */
	float:left;
	line-height: 90%;
	padding-right: 0.4em;
}
div.specdetails
{
	float:left;
	text-align: left
}
</style>
{%- if autocomplete_users %}
<datalist id="autocompleteUsers">
{%- for user in autocomplete_users %}
		<option>{{user.username}}</option>
{% endfor -%}
</datalist>
{% endif -%}
<form method="POST" role="form" class="form-horizontal">
	<input type="hidden" name="_csrf_token" value="{{ csrf_token() }}" />
	<div class="row">
		<div class="col-md-12">
			<h4 style="margin-top:0">1. Enter Request Details</h4>
			<div class="row">
				<div class="form-group col-md-12">
					<label for="purpose">Purpose:<span class="required">*</span></label><input class="form-control" id="purpose" name="purpose" placeholder="The purpose of the Virtual Machine, e.g. Corporate Website Web Server" autofocus />
				</div>
			</div>
			<div class="row">
				<div class="form-group col-md-12">
					<label for="comments">Comments:</label><input class="form-control" id="comments" name="comments" placeholder="Any other notes to store in the comments section of the CMDB" />
				</div>
			</div>
			<div class="row">
				<div class="form-group col-md-3">
					<label for="primary_owner_who">Primary Owner:</label><input class="form-control" list="autocompleteUsers" autocomplete="off" id="primary_owner_who" name="primary_owner_who" placeholder="Primary owner's username" maxlength="64"/>
				</div>
				<div class="form-group col-md-3">
					<label for="primary_owner_role">Primary Owner Role:</label><input class="form-control" id="primary_owner_role" name="primary_owner_role" placeholder="Primary owner's role" maxlength="64"/>
				</div>
				<div class="form-group col-md-3">
					<label for="secondary_owner_who">Secondary Owner:</label><input class="form-control" list="autocompleteUsers" autocomplete="off" id="secondary_owner_who" name="secondary_owner_who" placeholder="Secondary owner's username" maxlength="64"/>
				</div>
				<div class="form-group col-md-3">
					<label for="secondary_owner_role">Secondary Owner Role:</label><input class="form-control" id="secondary_owner_role" name="secondary_owner_role" placeholder="Secondary owner's role" maxlength="64"/>
				</div>
			</div>
		</div>
	</div>

	<div class="row" style="margin-top: 0.5em">
		<div class="col-md-12">
			<h4>2. Choose Base Specification</h4>
			<div class="btn-group row" data-toggle="buttons" id="specs" style="margin-left: 1em">
				<!-- Populated by JavaScript -->
			</div>
		</div>
	</div>

	<div class="row" style="margin-top: 1.6em">
		<div class="col-md-12">
			<h4>3. Customise Specification</h4>
			<div class="row">
				<div class="form-group col-md-3" style="margin-top:0.5em">
					<label for="sockets-slider">Sockets:</label>
					<input class="slider form-control-range slider-input" type="range" id="sockets-slider" name="sockets" style="width: 65%;" step="1" min="1" max="16" value="1">
					<span class="badge badge-primary output" style="font-size: 14px;"></span>
					<p class="text-muted">Number of CPU sockets</p>
				</div>
				<div class="form-group col-md-3" style="margin-top:0.5em">
					<label for="cores-slider">Cores:</label>
					<input class="slider form-control-range slider-input" type="range" id="cores-slider" name="cores" style="width: 65%;" step="1" min="1" max="16" value="1">
					<span class="badge badge-primary output" style="font-size: 14px;"></span>
					<p class="text-muted">Number of cores per socket</p>
				</div>
				<div class="form-group col-md-3" style="margin-top:0.5em">
					<label for="ram-slider">RAM (GB):</label>
					<input class="slider form-control-range slider-input" type="range" id="ram-slider" name="ram" style="width: 65%;" step="2" min="2" max="32" value="2">
					<span class="badge badge-primary output" style="font-size: 14px;"></span>
					<p class="text-muted">Total amount of RAM, including video RAM</p>
				</div>
				<div class="form-group col-md-3" style="margin-top:0.5em">
					<label for="disk-slider">Disk (GB):</label>
					<input class="slider form-control-range slider-input" type="range" id="disk-slider" name="disk" style="width: 65%;" step="100" min="100" max="2000" value="100">
					<span class="badge badge-primary output" style="font-size: 14px;"></span>
					<p class="text-muted">Additional disk size, for <samp>/srv</samp> or <samp>G:\</samp> (not the OS disk)</p>
				</div>
			</div>
		</div>
	</div>

	<div class="row" style="margin-top: 1.0em">
		<div class="col-md-4">
			<h4>4. Choose Image<span class="required">*</span></h4>
			<div style="margin-left:1em">
				<select class="selectpicker" name="template" id="template">
					<option></option>
{% for os in os_order -%}
					<option value="{{ os }}">{{ os_names[os] }}</option>
{%- endfor %}
				</select>
			</div>

			<h4 style="margin-top:2.2em">5. Choose Environment<span class="required">*</span></h4>
			<div style="margin-left:1em">
				<select class="selectpicker" name="environment" id="environment">
					<option></option>
{% for environment in environments -%}
					<option value="{{ environment.id }}"{% if default_env == environment.id %} selected="selected"{% endif %}>{{ environment.name }}</option>
{%- endfor %}
				</select>
			</div>
			<h4 style="margin-top:2.2em">6. Choose Location Cluster<span class="required">*</span></h4>
			<div style="margin-left:1em">
				<select class="selectpicker" name="cluster" id="cluster">
					<option></option>
{% for cluster in clusters -%}
					<option value="{{ cluster.name }}"{% if default_cluster == cluster.name %} selected="selected"{% endif %}>{{cluster.name}}</option>
{%- endfor %}
				</select>
			</div>
		</div>

		<div class="col-md-4">
			<h4>7. Expiry Date (optional)</h4>
			<div class="form-group" style="margin-left: 1em">
				<p>Set the date that this VM will be automatically powered off.</p>
				<div class='input-group date' id='expirypicker' data-target-input="nearest">
					<input type='text' class="form-control datetimepicker-input" id="expiry" name="expiry" placeholder="YYYY-MM-DD" data-target="expirypicker" />
					<span class="input-group-append" data-target="#expirypicker" data-toggle="datetimepicker">
						<div class="input-group-text"><i class="fa fa-calendar"></i></div>
					</span>
				</div>
				<script>
					$(function () {
						$('#expirypicker').datetimepicker({
							viewMode: 'days',
							format: 'YYYY-MM-DD',
							minDate: moment(),
							useCurrent: false,
						});
					});
				</script>
			</div>

			<h4>8. Summary</h4>
			<div style="margin-left: 1em">
				<p>A VM will be created with the following specifications.</p>
				<div style="font-size: 120%">
					<div><strong>vCPUs:</strong> <span id="val_vcpus">0</span></div>
					<div><strong>RAM:</strong> <span id="val_ram">0</span> GiB</div>
					<div><strong>Disk:</strong> <span id="val_disk">0</span> GiB</div>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<h4>9. Create</h4>
			<div style="margin:0 0 0.5em 1.0em">
				<input type="checkbox" name="send_mail" id="send_mail" style="margin-right:0.4em" checked="checked" /><label for="send_mail" style="position:relative;top:-2px">Notify me by e-mail when done</label>
			</div>
			<div class="submit">
				<button type="submit" class="btn btn-success btn-submit" id="create"><i class="fa fa-fw fa-plus"></i> Create</button>
			</div>
		</div>
	</div>
</form>
<script type="text/javascript">
// Dictionary of base VM specifications
var specs = {
	"spec1": {
		"name": "VM Specification 1",
		"sockets": 1,
		"cores": 1,
		"ram": 2,
		"disk": 100,
	},
	"spec2": {
		"name": "VM Specification 2",
		"sockets": 2,
		"cores": 1,
		"ram": 4,
		"disk": 200,
	},
	"spec3": {
		"name": "VM Specification 3",
		"sockets": 2,
		"cores": 2,
		"ram": 8,
		"disk": 400,
	},
	"spec4": {
		"name": "VM Specification 4",
		"sockets": 2,
		"cores": 4,
		"ram": 16,
		"disk": 800,
	},
};

// Specify an order to display them in as dictionaries aren't ordered
var specs_order = ["spec1", "spec2", "spec3", "spec4"]

/*****************************************************************************/
function updateTotals()
{
	// See what specification is selected
	var spec = $('input[name=spec]').filter(function(index){
		return $(this).is(':checked');
	});
	if (spec.length != 0)
	{
		// Extract information from specs
		var spec = specs[$(spec[0]).val()];
		var spec_sockets = spec['sockets'];
		var spec_cores = spec['cores'];
		var spec_ram = spec['ram'];
		var spec_disk = spec['disk'];
		// Set minimums on sliders (resets slider values to their minimum)
		setSliderMinimum('#ram-slider', spec_ram);
		setSliderMinimum('#disk-slider', spec_disk);

		// Update display
		$('#val_vcpus').text($("#sockets-slider").val() * $("#cores-slider").val());
		$('#val_ram').text($("#ram-slider").val());
		$('#val_disk').text($("#disk-slider").val());
	}
	
}

// Helper functions
function setSliderValue(selector, val)
{
	if ($(selector).val() != val)
	{
		$(selector).val(val);
		var selector_label = $(selector).parent().find(".output").eq(0);
		var selector_label_value = parseInt(selector_label.html());
		selector_label.html(val);
	}
	console.log("selector: " + selector + " val: "+ val + " current value: " + $(selector).attr('value'));
}

function setSliderMinimum(selector, minimum)
{
	if ($(selector).attr('min') != minimum)
	{
		$(selector).attr('min', minimum);
		var selector_label = $(selector).parent().find(".output").eq(0);
		var selector_label_value = parseInt(selector_label.html());
		if(selector_label_value != minimum){
			selector_label.html(minimum);
		}
		setSliderValue(selector, minimum);
	}
}
// Update the totals at startup
$(document).ready(function()
{
	first = true
	html = ""

	// Generate our base specification buttons
	for (idx in specs_order)
	{
		spec = specs_order[idx];
		html = html + '<label id="spec-template-'+ (parseInt(idx) + 1) + '" class="btn btn-primary spec-template' + (first ? ' active' : '') + '" style="cursor: pointer;"><input type="radio" name="spec" style="position: absolute; clip: rect(0, 0, 0, 0);" value="' + spec + '"><div class="specname">' + (parseInt(idx) + 1) + '</div><div class="specdetails">' + (specs[spec].sockets * specs[spec].cores) + ' CPU<br/>' + specs[spec].ram + ' GB RAM<br/>' + specs[spec].disk + ' GB Disk</div><div class="clearfix"></div></label>';
		$('#specs').html(html);

		if (first) { first = false; }
	}
	$("label.active > input[type=radio][name=spec]").prop('checked', true); // whichever label is active needs to also be checked
	// Update the totals when the inputs change
	$('input[type=range], input[type=radio][name=spec]').on('input', function() { updateTotals(); });
	$('input[type=radio][name=spec]').change(function() {
		var spec = $('input[name=spec]').filter(function(index){
			return $(this).is(':checked');
		});
		var spec = specs[$(spec[0]).val()];
		var spec_sockets = spec['sockets'];
		var spec_cores = spec['cores'];
		setSliderValue('#sockets-slider', spec_sockets);
		setSliderValue('#cores-slider', spec_cores);
		updateTotals();
	});

	// Perform initial update of values
	updateTotals();
	
});



// Callback for clicking Create button
$('#create').click(function(e) {
	// Validate
	if ($('#purpose').val().length == 0)
	{
		alert('You must enter a purpose for the VM.');
		$('#purpose').focus();
	}
	else if ($("#template").val() == "")
	{
		alert('You must select a VM image to use.');
	}
	else if ($("#environment").val() == "")
	{
		alert('You must select an environment.');
	}
	else if ($("#cluster").val() == "")
	{
		alert('You must select a location cluster.');
	}
	else
	{
		// Temporary as this workflow is not operational
		return true;
	}

	// We've hit an error condition, don't allow the form to submit
	e.preventDefault();
	return false;
});

var sliders = $(".slider-input");

sliders.each(function(){
	$(this).parent().find(".output").eq(0).html($(this).val());
});

sliders.on('input', function() {
	$(this).parent().find(".output").eq(0).html($(this).val());
	console.log($(this).val());
	$('#val_vcpus').text($("#sockets-slider").val() * $("#cores-slider").val());
	$('#val_ram').text($("#ram-slider").val());
	$('#val_disk').text($("#disk-slider").val());

});

{%- if os_types -%}
var os_types = {{ os_types | tojson }}
$('#template').change(function() {
	if (os_types["Linux"] && os_types["Linux"].includes(this.value)) {
		console.log("Linux");
	} else if (os_types["Windows"] && os_types["Windows"].includes(this.value)) {
		console.log("Windows");
	} else {
		console.log("Unknown OS")
	}
});
{%- endif -%}
</script>
{% endblock %}
