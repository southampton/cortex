{% extends "layout.html" %}
{% block head -%}
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/vendor/bootstrap-select.min.css') }}">
	<script type="text/javascript" src="{{ url_for('static', filename='js/vendor/bootstrap-select.min.js') }}"></script>
{% endblock %}
{% block body %}

<div class="modal fade" id="edit" role="dialog">
	<div class="modal-dialog">
		<div class="modal-content">
			<form role="form" method="POST" class="form-horizontal">
				<input name="_csrf_token" type="hidden" value="{{ csrf_token() }}"/>
				<input name="action" type="hidden" value="edit"/>
				<div class="modal-header">
					<h4 class="modal-title">Edit role</h4>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				</div>
				<div class="modal-body">
					<div class="form-group row">
						<label class="col-sm-3 control-label">Name</label>
						<div class="col-sm-9">
							<input class="form-control" name="name" id="name" value="{{role.name}}"/>
						</div>
					</div>

					<div class="form-group row">
						<label class="col-sm-3 control-label">Description</label>
						<div class="col-sm-9">
							<input class="form-control" type="text" name="description" id="description" value="{{role.description}}" />
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-light" data-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-primary">Save</button>
				</div>
			</form>
		</div>
	</div>
</div>

<div class="modal fade" id="delete" role="dialog">
	<div class="modal-dialog">
		<div class="modal-content">
			<form role="form" method="POST" class="form-horizontal">
				<input name="_csrf_token" type="hidden" value="{{ csrf_token() }}"/>
				<input name="action" type="hidden" value="delete"/>
				<div class="modal-header">
					<h4 class="modal-title">Delete role</h4>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				</div>
				<div class="modal-body">
					<p>Are you sure you want to delete this role?</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-light" data-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-warning">Yes, nuke it from orbit!</button>
				</div>
			</form>
		</div>
	</div>
</div>

<div class="modal fade" id="add" role="dialog">
	<div class="modal-dialog">
		<div class="modal-content">
			<form role="form" method="POST" class="form-horizontal">
				<input name="_csrf_token" type="hidden" value="{{ csrf_token() }}"/>
				<input name="action" type="hidden" value="add"/>
				<div class="modal-header">
					<h4 class="modal-title">Add user or group</h4>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				</div>
				<div class="modal-body">
					<div class="form-group row">
						<label class="col-sm-2 control-label">Type</label>
						<div class="col-sm-10">
							<select name="type" class="form-control">
								<option value="0">User</option>
								<option value="1">Active Directory Group</option>
							</select>
						</div>
					</div>
					<div class="form-group row">
						<label class="col-sm-2 control-label">Name</label>
						<div class="col-sm-10">
							<input class="form-control" name="name" value="" placeholder="User or group name"/>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-light" data-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-primary">Add</button>
				</div>
			</form>
		</div>
	</div>
</div>

<div class="modal fade" id="addSystem" role="dialog">
	<div class="modal-dialog">
		<div class="modal-content">
			<form role="form" method="POST" class="form-horizontal">
				<input name="_csrf_token" type="hidden" value="{{ csrf_token() }}"/>
				<input name="action" type="hidden" value="add_system"/>
				<div class="modal-header">
					<h4 class="modal-title">Add system</h4>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				</div>
				<div class="modal-body">
					<div class="form-group row">
						<label class="col-sm-2 control-label">Name</label>
						<div class="col-sm-10">
							<select class="selectpicker" name="name" data-live-search="true" data-width="100%">
								{%- for system in systems %}
								<option value="{{ system['name'] }}">{{ system['name'] }} - {{ system['allocation_comment'] }}</option>
								{% endfor -%}
							</select>	
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-light" data-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-primary">Add</button>
				</div>
			</form>
		</div>
	</div>
</div>


<div class="modal fade" id="remove" role="dialog">
	<div class="modal-dialog">
		<div class="modal-content">
			<form role="form" method="POST" class="form-horizontal">
				<input name="_csrf_token" type="hidden" value="{{ csrf_token() }}"/>
				<input name="action" type="hidden" value="remove"/>
				<input id="remove-who-id" name="wid" type="hidden" value=""/>
				<div class="modal-header">
					<h4 class="modal-title">Remove user/group</h4>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				</div>
				<div class="modal-body">
					<p>Are you sure you want to remove '<span id="remove-who-text">unknown</span>' from this role?</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-light" data-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-warning">Remove</button>
				</div>
			</form>
		</div>
	</div>
</div>

<div class="modal fade" id="removeSystem" role="dialog">
	<div class="modal-dialog">
		<div class="modal-content">
			<form role="form" method="POST" class="form-horizontal">
				<input name="_csrf_token" type="hidden" value="{{ csrf_token() }}"/>
				<input name="action" type="hidden" value="remove_system"/>
				<input id="remove-what-id" name="sid" type="hidden" value=""/>
				<div class="modal-header">
					<h4 class="modal-title">Remove system</h4>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				</div>
				<div class="modal-body">
					<p>Are you sure you want to remove '<span id="remove-what-text">unknown</span>' from this role?</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-light" data-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-warning">Remove</button>
				</div>
			</form>
		</div>
	</div>
</div>


<div class="page-header">
	<div class="pull-right">
		<a data-toggle="modal" data-target="#edit" class="btn btn-warning" style="color: white;"><i class="fa fa-fw fa-edit"></i> <span class="d-sm-none d-none d-md-inline">Edit role</span></a>
		<a data-toggle="modal" data-target="#delete" class="btn btn-danger" style="color: white;"><i class="fa fa-fw fa-trash"></i> <span class="d-sm-none d-none d-md-inline">Delete role</span></a>
	</div>
	<h4><i class="fa fa-fw fa-user-secret"></i> {{role.name}}</h4>
	<div class="text-muted">{{role.description}}</div>
</div>

<div class="row">
	<div class="col-md-6">
		<form role="form" method="POST" class="form-horizontal">
		<div class="card card-default">
			<div class="card-header">
				<div class="pull-right">
					<button type="submit" class="btn btn-sm btn-primary" style="font-size: 12px;">Save</button>
				</div>
				<h4 class="card-title">Permissions</h4>
			</div>
		
			<div class="card-body">
				<input name="_csrf_token" type="hidden" value="{{ csrf_token() }}"/>
				<input name="action" type="hidden" value="update"/>

				<fieldset>
				{% if perms %}
				<legend>Global permissions</legend>

				{% for perm in perms %}
				<div class="checkbox">
					<label>
						<input type="checkbox" id="{{perm['name']}}" name="{{perm['name']}}" value="yes"{% if perm['name'] in rperms %} checked="checked"{%endif%}>
						{{ perm['desc'] }}
					</label>
				</div>
				{% endfor %}
				</fieldset>
				{% endif %}

				<fieldset>

				{% if wfperms %}
				<legend>Workflow permissions</legend>

				{% for perm in wfperms %}
				<div class="checkbox">
					<label>
						<input type="checkbox" id="{{perm['name']}}" name="{{perm['name']}}" value="yes"{% if perm['name'] in rperms %} checked="checked"{%endif%}>
						{{ perm['desc'] }}
					</label>
				</div>
				{% endfor %}
				{% endif %}

				{% if system_perms %}
				<legend>System permissions</legend>

				{% for perm in system_perms %}
				<div class="checkbox">
					<label>
						<input type="checkbox" id="{{perm['name']}}" name="{{perm['name']}}" value="yes"{% if perm['name'] in rperms %} checked="checked"{%endif%}>
						{{ perm['desc'] }}
					</label>
				</div>
				{% endfor %}
				{% endif %}
				</fieldset>

				<div class="text-center">
					<button type="submit" class="btn btn-primary">Save</button>
				</div>
			</div>
		</div>
		</form>
	</div>
	<div class="col-md-6">
		<div class="card card-default">
			<div class="card-header">
				<div class="pull-right"><a data-toggle="modal" data-target="#add" class="btn btn-sm btn-success"><i class="fa fa-fw fa-plus" style="color: white;"></i></a></a></div>
				<h4 class="card-title">Users and groups</h4>
			</div>
			<table class="table table-striped table-hover table-sm role-table">
				<tbody>
					{% for who in role['who'] %}
					<tr>
						<td><span class="text-muted">{% if who['type'] == 0 %}<i class="fa fa-user"></i> User</span> {{who['who']}} {% if who['realname'] %} ({{who['realname']}}) {%endif%} {%elif who['type'] == 1 %}<i class="fa fa-windows"></i> AD Group</span> {{who['who']}}{%else%}Unknown entry{%endif%}</span></td>
						<td class="text-right"><a data-toggle="modal" data-target="#remove" data-name="{{who['who']}}" data-wid="{{who['id']}}" class="btn btn-sm btn-danger" style="color: white; font-size: 12px;">Remove</a></td>
					</tr>
					{%else%}
					<tr><td colspan="2"><span class="text-muted">No users or groups have been assigned to this role</span></td></tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		{% if 'what' in role %}
		<div class="card card-default">
			<div class="card-header">
				<div class="pull-right"><a data-toggle="modal" data-target="#addSystem" class="btn btn-sm btn-success" style="color: white;"><i class="fa fa-fw fa-plus"></i></a></a></div>
				<h4 class="card-title">Systems</h4>
			</div>
			<table class="table table-striped table-hover table-sm role-table">
				<tbody>
					{% for what in role['what'] %}
					<tr>
						<td><span class="text-muted"><i class="fa fa-server"> </i> System</span> {{what['name']}}</td>
						<td class="text-right"><a data-toggle="modal" data-target="#removeSystem" data-name="{{what['name']}}" data-sid="{{what['system_id']}}" class="btn btn-sm btn-danger" style="color: white; font-size: 12px;">Remove</a></td>
					</tr>
					{%else%}
					<tr><td colspan="2"><span class="text-muted">No systems have been assigned to this role</span></td></tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		{% endif %}
	</div>
</div>

<script type="text/javascript">
$( document ).ready(function() 
{
	/* What is this doing?? */
	$('#revoke').on('show.bs.modal', function (event)
	{
		var link = $(event.relatedTarget)

		$('#revoke-permission-text').text(link.data('name'));
		$('#revoke-permission-id').val(link.data('pid'));
	})

	$('#remove').on('show.bs.modal', function (event)
	{
		var link = $(event.relatedTarget)

		$('#remove-who-text').text(link.data('name'));
		$('#remove-who-id').val(link.data('wid'));
	})
	
	$('#removeSystem').on('show.bs.modal', function (event)
	{
		var link = $(event.relatedTarget)

		$('#remove-what-text').text(link.data('name'));
		$('#remove-what-id').val(link.data('sid'));
	})


});
</script>
{% endblock %}
